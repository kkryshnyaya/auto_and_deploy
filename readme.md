**Итоговая работа «Автоматизация и деплой»**

**Задача**

Представьте, что вы работаете в крупной торговой сети и продаете товары для дома - бытовую химию, текстиль, кухонную утварь и так далее. Каждый день из кассового софта в специально созданную папку на сервере выгружается набор csv-файлов с информацией по чекам и продажам. Ваша задача - автоматизировать обработку этих данных (а также написать скрипт для их генерации, чтобы эмулировать работу кассовой программы).

**Реализация**

1) logs.py
* Настройка логирования;
* Удаление логов старше 7 дней;
* Класс Logs импортируется во все остальные модули;

2) sales_generator.py
* Генерация продаж (csv-файлов) и сохранение в папку;
* Продажи формируются за вчерашний день;
* Каждой кассе каждого магазина соответствует отдельный файл;
* Идентификатор чека уникальный;

3) database.py
* Объединение кассовых файлов в единый отчет;
* Загрузка отчета в БД Postgres;

4) run.py
* Итоговый модуль, содержащий логику работы программы;
* Сюда импортируются классы из модулей выше;
* Скрипт проверяет вчерашний день недели, если это воскресенье – скрипт завершает работу (файлы по продажам не генерируются, в БД ничего не попадает, в логах делается соответствующая запись). 
* Если в папке с продажами есть файлы, то они загружаются в БД, после чего удаляются;
* Настроено гарантированное закрытие курсора и соединения с БД;

**Вспомогательные файлы**

5) constants.ini 

Наименования директорий, параметры торговой сети, категории товаров и собственно товары;

6) creds.ini

Параметры подключения к БД, поэтому попадает в .gitignore. На удаленном сервере создан клон этого файла, так как скрипт на него ссылается;

7) requirements.txt

Список необходимых библиотек;

**Дополнительно настроено**
* Автоматизация с помощью crontab, скрипт запускается ежедневно в 09.10;
* Шаблон дашборда в Metabase, http://95.163.230.43:3000/dashboard/2-home-store 

**Как запустить проект на новой машине**

Инструкция рассчитана на развёртывание проекта на новой машине (удалённой или локальной).

* Обновить систему (список пакетов и сами пакеты)

apt update

apt upgrade -y

* Установить Python виртуальное окружени

Проект работает на Python 3.12.10

apt install python3 -y 

apt install python3-venv -y


* Клонировать проект и перейти в папку проекта

git clone https://github.com/kkryshnyaya/
auto_and_deploy.git

cd auto_and_deploy

* Создать виртуальное окружение и установить зависимости

python3 -m venv venv

source venv/bin/activate

pip install -r requirements.txt

* Создать файл creds.ini

В репозитории файл отсутствует, требуется вручную: 
nano creds.ini

[Database]

HOST = localhost

PORT = 5432

USER = user

PASSWORD = password

Сохранить и выйти: Ctrl+O → Enter → Ctrl+X

Для получения USER и PASSWORD свяжитесь с разработчиком.

* Настроить базу данных Postgres

На новой машине нужно установить Postgres: 

apt install postgresql -y

Создать базу: 

sudo -u postgres created home_store

Проверить подключение: 

psql -U postgres -d sales_db

Таблицу создавать не нужно, она создается благодаря методу Database.create_table(cursor)

* Запуск проекта вручную

source venv/bin/activate

python run.py

* Настройка автоматического запуска через cron

Открыть crontab:

EDITOR=nano crontab -e

Добавить строку (ежедневный запуск в 09:10):

10 09 * * * /home/auto_and_deploy/venv/bin/python /home/auto_and_deploy/run.py

Проект лежит в папке home.

Проверить, что запись добавлена:

crontab -l

* Где искать логи

Логи сохраняются автоматически в папке logs (создается скриптом).

После выполнения этих шагов проект должен функционировать.

Также при желании можно установить DBeaver, Metabase.